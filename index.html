<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BC Roads Companion</title>
    <meta name="theme-color" content="#003366">
    
    <style>
        :root {
            --primary: #003366;
            --secondary: #e3f2fd;
            --danger: #d32f2f;
            --success: #2e7d32;
            --warning: #f57c00;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll, handle in app-container */
        }

        .app-container {
            width: 100%;
            max-width: 450px;
            background-color: white;
            height: 100%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* --- Header --- */
        .header {
            background-color: var(--primary); 
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .header h1 { margin: 0; font-size: 20px; font-weight: 600; }

        /* --- Region Select --- */
        .region-bar {
            background-color: #004488;
            padding: 10px;
        }
        select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            background: #fff;
        }

        /* --- Controls Grid --- */
        .controls {
            padding: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 10px;
            background: #fff;
        }

        .btn {
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .btn:active { transform: scale(0.96); }

        .btn-gps { grid-column: span 2; background-color: var(--success); font-size: 16px; padding: 15px; }
        .btn-closure { background-color: var(--danger); }
        .btn-advisory { background-color: var(--warning); }
        .btn-chain { background-color: #1976d2; }
        .btn-all { background-color: #546e7a; }

        /* --- Voice Bar --- */
        .voice-bar {
            padding: 10px;
            background: var(--secondary);
            border-bottom: 1px solid #ddd;
            display: none; /* Hidden by default */
            display: flex; /* Changed via JS */
            gap: 10px;
            align-items: center;
        }

        .btn-voice-control {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            color: white;
            cursor: pointer;
        }
        .btn-play { background-color: #673ab7; }
        .btn-stop { background-color: #d32f2f; }
        
        /* Pulse animation for when speaking */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(103, 58, 183, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(103, 58, 183, 0); }
            100% { box-shadow: 0 0 0 0 rgba(103, 58, 183, 0); }
        }
        .speaking-active {
            animation: pulse 1.5s infinite;
            background-color: #512da8 !important;
        }

        /* --- Results List --- */
        .results-area {
            flex-grow: 1;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 15px;
            scroll-behavior: smooth;
        }

        .status-card {
            background: white;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 8px;
            border-left: 6px solid #ccc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .status-card.active-read {
            background-color: #fff9c4; /* Yellow highlight */
            transform: scale(1.02);
            border-left-color: #673ab7 !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .road-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .road-name { font-weight: 800; font-size: 15px; text-transform: capitalize; }
        .dist-tag { background: #333; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; }

        .timestamp { font-size: 11px; color: #888; margin-top: 8px; display: block; }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="header">
            <h1>BC Roads Companion</h1>
        </div>

        <div class="region-bar">
            <select id="regionSelect" onchange="resetDisplay()">
                <option value="">üåç All of BC</option>
                <option value="-123.6,49.0,-121.0,49.9">üèôÔ∏è Lower Mainland</option>
                <option value="-128.5,48.3,-123.0,51.0">‚õ¥Ô∏è Vancouver Island</option>
                <option value="-121.5,49.0,-118.0,52.5">üçá Interior (Coq/Hwy 97)</option>
                <option value="-118.0,48.8,-114.0,52.0">üèîÔ∏è Kootenays</option>
                <option value="-132.0,52.0,-120.0,60.0">üå≤ Northern BC</option>
            </select>
        </div>

        <div class="controls">
            <button class="btn btn-gps" onclick="checkNearby()">üìç Check My 5km Radius</button>
            <button class="btn btn-closure" onclick="fetchData('Closures')">‚õî Closures</button>
            <button class="btn btn-advisory" onclick="fetchData('Advisories')">‚ö†Ô∏è Advisories</button>
            <button class="btn btn-chain" onclick="fetchData('Chain Ups')">‚õìÔ∏è Chain Ups</button>
            <button class="btn btn-all" onclick="fetchData('All')">üìÑ Show All</button>
        </div>

        <div class="voice-bar" id="voiceControls" style="display:none;">
            <button id="btnPlay" class="btn-voice-control btn-play" onclick="toggleVoiceSequence()">
                üîä Read All
            </button>
            <button class="btn-voice-control btn-stop" onclick="stopSpeaking()" style="flex: 0 0 60px;">
                ‚èπÔ∏è
            </button>
        </div>

        <div class="results-area" id="output">
            <p style="text-align:center; color:#777; margin-top: 40px;">
                Select a region or use GPS.
            </p>
        </div>
    </div>

    <script>
        const BASE_URL = "https://api.open511.gov.bc.ca/events?status=ACTIVE&limit=100";
        
        // State
        let currentEvents = [];
        let readingIndex = 0;
        let isReadingSequence = false;

        function resetDisplay() {
            document.getElementById('output').innerHTML = '<p style="text-align:center; color:#777; margin-top:40px;">Filter changed. Tap a button.</p>';
            stopSpeaking();
            document.getElementById('voiceControls').style.display = 'none';
        }

        // --- 1. DATA FETCHING ---
        async function fetchData(type) {
            stopSpeaking();
            const display = document.getElementById('output');
            const regionBox = document.getElementById('regionSelect').value;
            
            let url = BASE_URL;
            if (regionBox) url += `&bbox=${regionBox}`;

            display.innerHTML = '<p style="text-align:center; margin-top:40px;">üîÑ Loading DriveBC data...</p>';

            try {
                const response = await fetch(url);
                const data = await response.json();
                processEvents(data.events, type);
            } catch (error) {
                console.error(error);
                display.innerHTML = `<div class="status-card" style="border-left-color:red"><strong>Connection Error</strong><br>Ensure you are online.</div>`;
            }
        }

        // --- 2. GPS LOGIC ---
        function checkNearby() {
            stopSpeaking();
            const display = document.getElementById('output');
            
            if (!navigator.geolocation) {
                display.innerHTML = '<div class="status-card">GPS not supported by browser.</div>';
                return;
            }

            display.innerHTML = '<p style="text-align:center; margin-top:40px;">üõ∞Ô∏è Acquiring GPS...</p>';

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const myLat = pos.coords.latitude;
                const myLon = pos.coords.longitude;

                // Expand search box slightly around user to hit the API
                // 1 deg lat approx 111km. 0.5 is plenty to catch API data then filter locally
                const bbox = `${myLon-0.5},${myLat-0.5},${myLon+0.5},${myLat+0.5}`;
                
                try {
                    const response = await fetch(`${BASE_URL}&bbox=${bbox}`);
                    const data = await response.json();
                    
                    // Client-side precise filtering for 5km
                    const nearby = data.events.filter(e => {
                        if(!e.geography || !e.geography.coordinates) return false;
                        // Handle Point vs LineString (take first point of line)
                        let coords = e.geography.coordinates;
                        if(Array.isArray(coords[0])) coords = coords[0]; 
                        
                        const dist = getDistance(myLat, myLon, coords[1], coords[0]);
                        e.distanceKM = dist.toFixed(1);
                        return dist <= 5; // 5km Radius
                    });
                    
                    nearby.sort((a,b) => a.distanceKM - b.distanceKM);
                    processEvents(nearby, "Nearby");

                } catch(e) {
                    display.innerHTML = '<div class="status-card">Error calculating location data.</div>';
                }
            }, () => {
                display.innerHTML = '<div class="status-card" style="border-left-color:red"><strong>GPS Denied</strong><br>Check permissions.</div>';
            });
        }

        // --- 3. PROCESSING & FILTERING ---
        function processEvents(events, type) {
            let filtered = [];
            let title = type;

            if (type === 'Closures') {
                filtered = events.filter(e => 
                    (e.headline.includes('CLOSED') || e.description.includes('CLOSED')) && 
                    !e.headline.includes('LANE') // Exclude single lane closures from "Closures" button
                );
            } else if (type === 'Advisories') {
                filtered = events.filter(e => !e.headline.includes('CLOSED') || e.headline.includes('LANE'));
            } else if (type === 'Chain Ups') {
                filtered = events.filter(e => e.description.toUpperCase().includes('CHAIN') || e.description.includes('WINTER'));
            } else {
                filtered = events; // Nearby or All
            }

            renderList(filtered, title);
        }

        // --- 4. RENDERING ---
        function renderList(events, title) {
            const display = document.getElementById('output');
            currentEvents = events;
            
            if (events.length === 0) {
                display.innerHTML = `<h3>${title}</h3><div class="status-card" style="border-left-color:green">No active events found.</div>`;
                document.getElementById('voiceControls').style.display = 'none';
                return;
            }

            document.getElementById('voiceControls').style.display = 'flex';
            document.getElementById('btnPlay').innerText = `üîä Read ${events.length} Alerts`;

            let html = `<h3>${title} (${events.length})</h3>`;
            
            events.forEach((item, index) => {
                const cleanName = getSmartName(item.headline);
                const desc = item.description.split('\n')[0]; // First line usually enough
                const date = new Date(item.updated).toLocaleString();
                
                let color = "#1976d2"; // blue
                let icon = "‚ö†Ô∏è";
                if(item.headline.includes("CLOSED")) { color = "#d32f2f"; icon = "‚õî"; }
                
                let distBadge = item.distanceKM ? `<span class="dist-tag">${item.distanceKM} km</span>` : '';

                html += `
                <div class="status-card" id="card-${index}" style="border-left-color: ${color}">
                    <div class="road-header">
                        <span class="road-name" style="color:${color}">${icon} ${cleanName}</span>
                        ${distBadge}
                    </div>
                    <div style="font-size:13px; color:#333; line-height:1.4">${desc}</div>
                    <span class="timestamp">Updated: ${date}</span>
                </div>`;
            });

            display.innerHTML = html;
        }

        // --- 5. VOICE ENGINE (AUTO-ADVANCE) ---
        function toggleVoiceSequence() {
            if (isReadingSequence) {
                stopSpeaking();
            } else {
                startVoiceSequence();
            }
        }

        function startVoiceSequence() {
            if(currentEvents.length === 0) return;
            isReadingSequence = true;
            readingIndex = 0;
            
            document.getElementById('btnPlay').innerText = "Pause Reading";
            document.getElementById('btnPlay').classList.add("speaking-active");
            
            speakNext();
        }

        function speakNext() {
            if (!isReadingSequence || readingIndex >= currentEvents.length) {
                stopSpeaking(); // Finished
                return;
            }

            // Highlight UI
            document.querySelectorAll('.status-card').forEach(c => c.classList.remove('active-read'));
            const card = document.getElementById(`card-${readingIndex}`);
            if(card) {
                card.classList.add('active-read');
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            const item = currentEvents[readingIndex];
            const name = getSmartName(item.headline);
            // Clean text for speech (remove URLs, weird chars)
            let text = `${name}. ${item.description.split('.')[0]}`; 
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1.0;
            
            utterance.onend = function() {
                readingIndex++;
                setTimeout(speakNext, 1000); // 1 second pause between alerts
            };
            
            window.speechSynthesis.speak(utterance);
        }

        function stopSpeaking() {
            window.speechSynthesis.cancel();
            isReadingSequence = false;
            readingIndex = 0;
            
            document.getElementById('btnPlay').classList.remove("speaking-active");
            document.getElementById('btnPlay').innerText = currentEvents.length > 0 ? `üîä Read ${currentEvents.length} Alerts` : "üîä Read All";
            document.querySelectorAll('.status-card').forEach(c => c.classList.remove('active-read'));
        }

        // --- HELPER UTILS ---
        function getSmartName(headline) {
            let name = headline.split(' at ')[0].split(' between ')[0].split(' form ')[0];
            return name.replace('Highway', 'Hwy').trim();
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
    </script>
</body>
</html>